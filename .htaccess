
Options -Indexes -MultiViews
ServerSignature Off

# Compressão GZIP
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
  AddOutputFilterByType DEFLATE application/x-font
  AddOutputFilterByType DEFLATE application/x-font-opentype
  AddOutputFilterByType DEFLATE application/x-font-otf
  AddOutputFilterByType DEFLATE application/x-font-truetype
  AddOutputFilterByType DEFLATE application/x-font-ttf
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE font/opentype
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE image/x-icon
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml

  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  Header append Vary User-Agent
</IfModule>

<IfModule mod_rewrite.c>
RewriteEngine On

# Definir index.php como página padrão
DirectoryIndex index.php

# Proteção contra SQL Injection e ataques
RewriteCond %{QUERY_STRING} DECLARE [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} SELECT [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} DELETE [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} TRUNCATE [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} DROP [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} INSERT [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} SHOW [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} TABLES [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} SCHEMA [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} REPLACE [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} GRANT [NC]
RewriteRule !403\.html$ - [F]
RewriteCond %{QUERY_STRING} CREATE [NC]
RewriteRule !403\.html$ - [F]

# Proteção contra bots maliciosos
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
RewriteRule .* - [F]

# Proteção contra XSS e injeções
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^i]*i)+frame.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
RewriteCond %{QUERY_STRING} base64_(en|de)code[^(]*\([^)]*\) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>).* [NC,OR]
RewriteCond %{QUERY_STRING} (NULL|OUTFILE|LOAD_FILE) [OR]
RewriteCond %{QUERY_STRING} (\./|\../|\.../)+(motd|etc|bin) [NC,OR]
RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{QUERY_STRING} concat[^\(]*\( [NC,OR]
RewriteCond %{QUERY_STRING} union([^s]*s)+elect [NC,OR]
RewriteCond %{QUERY_STRING} union([^a]*a)+ll([^s]*s)+elect [NC,OR]
RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|%0A|%0D|%22|%27|%3C|%3E|%00).*(/\*|union|select|insert|drop|delete|update|cast|create|char|convert|alter|declare|order|script|set|md5|benchmark|encode) [NC,OR]
RewriteCond %{QUERY_STRING} (sp_executesql) [NC]
RewriteRule .* - [F]

# URLs amigáveis - remover .php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+?)/?$ $1.php [L,QSA]

# Redirecionar .php para URL limpa
RewriteCond %{THE_REQUEST} /([^.]+)\.php [NC]
RewriteRule ^ /%1? [NC,L,R=301]

# Redirecionar .html para .php (migração)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.*)\.html$ $1.php [L,R=301]

</IfModule>

# Proteção de arquivos sensíveis
<Files "composer.json">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.lock">
    Order allow,deny
    Deny from all
</Files>

<Files ".env">
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

<files ~ "^.*\.([Hh][Tt][Aa])">
    order allow,deny
    deny from all
    satisfy all
</files>

# CORS para JSON
<FilesMatch "\.json$">
  Header set Access-Control-Allow-Origin "*"
</FilesMatch>

# Bloqueio de bots maliciosos
<IfModule mod_setenvif.c>
    SetEnvIfNoCase User-Agent "^Baiduspider" badbotlist
    SetEnvIfNoCase User-Agent "^BlackWidow" badbotlist
    SetEnvIfNoCase User-Agent "^Curl" badbotlist
    SetEnvIfNoCase User-Agent "^Download" badbotlist
    SetEnvIfNoCase User-Agent "Downloader" badbotlist
    SetEnvIfNoCase User-Agent "Extractor" badbotlist
    SetEnvIfNoCase User-Agent "^GetRight" badbotlist
    SetEnvIfNoCase User-Agent "^GetWeb!" badbotlist
    SetEnvIfNoCase User-Agent "^Go!Zilla" badbotlist
    SetEnvIfNoCase User-Agent "Grabber" badbotlist
    SetEnvIfNoCase User-Agent "^Harvest" badbotlist
    SetEnvIfNoCase User-Agent "^HTTrack" badbotlist
    SetEnvIfNoCase User-Agent "^NetAnts" badbotlist
    SetEnvIfNoCase User-Agent "^Offline\ Explorer" badbotlist
    SetEnvIfNoCase User-Agent "^Offline\ Navigator" badbotlist
    SetEnvIfNoCase User-Agent "Reaper" badbotlist
    SetEnvIfNoCase User-Agent "Recorder" badbotlist
    SetEnvIfNoCase User-Agent "Siphon" badbotlist
    SetEnvIfNoCase User-Agent "Stripper" badbotlist
    SetEnvIfNoCase User-Agent "Sucker" badbotlist
    SetEnvIfNoCase User-Agent "^Teleport" badbotlist
    SetEnvIfNoCase User-Agent "^Web\ Sucker" badbotlist
    SetEnvIfNoCase User-Agent "^WebCopier" badbotlist
    SetEnvIfNoCase User-Agent "^WebReaper" badbotlist
    SetEnvIfNoCase User-Agent "^WebStripper" badbotlist
    SetEnvIfNoCase User-Agent "^Wget" badbotlist
    SetEnvIfNoCase User-Agent "Whacker" badbotlist
    SetEnvIfNoCase User-Agent "^Xenu" badbotlist
    SetEnvIfNoCase User-Agent "ZmEu" badbotlist
    
    <RequireAll>
        Require all granted
        Require not env badbotlist
    </RequireAll>
</IfModule>

# Headers de segurança
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# Cache para performance
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Bloquear acesso direto a includes
<Files ~ "^(head|header|footer)\.php$">
    Order allow,deny
    Deny from all
</Files>

# Bloquear tentativas de acesso a arquivos de backup
<FilesMatch "\.(bak|backup|old|tmp|temp|swp|swo|orig|save)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Forçar HTTPS (descomente se tiver SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Bloquear hotlinking de imagens
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?pincelatomico\.com\.br [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg|webp)$ - [F]